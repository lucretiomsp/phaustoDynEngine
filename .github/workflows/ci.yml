name: Test Dynamic Engine Linking

on:
  push:
  pull_request:
  workflow_dispatch:

jobs:
  test-dynamic-lib:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Prepare library
        run: |
          mkdir -p build
          cp librariesBundle_Linux/libdynamic-engine.so build/
          echo "✅ Copied library to build directory"
          ls -l build/

      - name: Check for missing dependencies
        run: |
          cd build
          echo "🔍 Checking shared library dependencies..."
          if ldd libdynamic-engine.so | grep "not found"; then
            echo "❌ Missing dependencies in libdynamic-engine.so"
            exit 1
          else
            echo "✅ All dependencies are found"
          fi

      - name: Verify exported symbols
        run: |
          cd build
          echo "🔍 Checking for expected symbols..."
          nm -D libdynamic-engine.so | grep createDspFromBoxes || (echo "❌ Missing symbol: createDspFromBoxes" && exit 1)
          echo "✅ Found required symbol: createDspFromBoxes"

      - name: Compile and run test
        run: |
          cd build
          echo "🧱 Compiling test..."
          g++ ../test/test_dynamic_engine.cpp -L. -ldynamic-engine -o test_dynamic_engine

          echo "🚀 Running test..."
          LD_LIBRARY_PATH=. ./test_dynamic_engine
