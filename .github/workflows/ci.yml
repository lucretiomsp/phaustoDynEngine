name: Test Dynamic Engine Linking

on:
  push:
  pull_request:
  workflow_dispatch:

jobs:
  test-dynamic-lib:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Prepare library
        run: |
          mkdir -p build
          cp librariesBundle_Linux/libdynamic-engine.so build/
          echo "âœ… Copied library to build directory"
          ls -l build/

      - name: Check for missing dependencies
        run: |
          cd build
          echo "ğŸ” Checking shared library dependencies..."
          if ldd libdynamic-engine.so | grep "not found"; then
            echo "âŒ Missing dependencies in libdynamic-engine.so"
            exit 1
          else
            echo "âœ… All dependencies are found"
          fi

      - name: Verify exported symbols
        run: |
          cd build
          echo "ğŸ” Checking for expected symbols..."
          nm -D libdynamic-engine.so | grep createDspFromBoxes || (echo "âŒ Missing symbol: createDspFromBoxes" && exit 1)
          echo "âœ… Found required symbol: createDspFromBoxes"

      - name: Compile and run test
        run: |
          cd build
          echo "ğŸ§± Compiling test..."
          g++ ../test/test_dynamic_engine.cpp -L. -ldynamic-engine -o test_dynamic_engine

          echo "ğŸš€ Running test..."
          LD_LIBRARY_PATH=. ./test_dynamic_engine
